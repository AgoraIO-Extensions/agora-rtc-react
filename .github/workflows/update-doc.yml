name: Update Docs

on:
  workflow_dispatch:
jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout origin repo ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          repository: guoxianzhe/docs
          ref: main
          path: "./video-call/react/docs"
          # token: ${{ secrets.AGORAIO_ACCESS_TOKEN }}

      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Install pnpm ğŸ¤ğŸ»
        uses: pnpm/action-setup@v2.2.4
        with:
          version: latest

      - name: Setup Node ğŸ’š
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "pnpm"

      - name: Update Docs ğŸ“–
        run: |
          git config --global user.email "${{ secrets.GIT_EMAIL }}"
          git config --global user.name "${{ secrets.GIT_USERNAME }}"
          ls
          cp -r ./video-call/react/docs/* ./packages/agora-rtc-react/docs
          git checkout -b doc/update-doc
          pnpm install
          pnpm gene-docs
          if git diff --quiet;
          then echo "No changes, no need to update docs";
          else
            git add .
            git commit -m "docs: update doc"
            git push origin doc/update-doc
          fi
      - name: Create Pull Request ğŸ“
        run: |
          if gh pr list --state open --head doc/update-doc | grep -q "No open pull requests";
            then gh pr create -B ${{ github.ref_name }} -H doc/update-doc --title '[AUTO] ğŸ“–update docs' --body 'Created by Github action' --label 'ci:doc-update'
          else
            echo "PR already exists for this branch"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
